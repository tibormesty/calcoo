/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
let fteElementVisible=!1,animationFrameTicking=!1,state={addedAdobeCleanFont:!1,tooltipAttachedImage:null};const exceptionList=["*.youtube.com","*.netflix.com","*.primevideo.com","*.hulu.com","tv.apple.com","*.disney.*","pinterest.com","*.pinterest.com"],createAcrobatIconElement=e=>{const t=document.createElement("img");return t.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png")),t.setAttribute("class",`${e}-tooltip-icon`),t};function createFTEDiv(e,t,o){const n=document.createElement("div");n.setAttribute("class",`${o}-tooltip`);const i=document.createElement("div");if(i.setAttribute("class",`${o}-tooltiptext`),i.style.zIndex="1000001",i.classList.add(`${o}-tooltiptext-top`),e.title){const t=document.createElement("div");t.setAttribute("class",`${o}-tooltiptext-title`);const n=createAcrobatIconElement(o);t.appendChild(n);const s=document.createElement("div");s.textContent=e.title,s.setAttribute("class",`${o}-tooltiptext-title-text`),t.appendChild(s),i.appendChild(t)}if(e.description){const t=document.createElement("div");t.innerHTML=e.description,t.setAttribute("class",`${o}-tooltiptext-description`),i.appendChild(t)}if(e.footer){const t=document.createElement("div");t.innerHTML=e.footer,t.setAttribute("class",`${o}-tooltiptext-footer`),i.appendChild(t)}return n.appendChild(i),{fteElement:n,tooltipContent:i}}const sendAnalyticsEvent=e=>{try{chrome.runtime.sendMessage({main_op:"analytics",analytics:e})}catch(e){}};function createExpressFTE(e,t){const{fteElement:o,tooltipContent:n}=createFTEDiv(e,t,"ae68bdebea-express");if(o.setAttribute("id","express-tooltip-ae68bdebea"),!fteElementVisible){n.style.visibility="visible",fteElementVisible=!0;const e=new URL(window.location.href).hostname;sendAnalyticsEvent([["DCBrowserExt:Express:FTETooltip:Shown",{domain:e}]]),updateChromeStoreInfo()}function i(e){fteElementVisible&&e.target!==o&&(n.style.visibility="hidden",fteElementVisible=!1,sendAnalyticsEvent([["DCBrowserExt:Express:FTETooltip:Dismissed"]]),document.removeEventListener("click",i),document.removeEventListener("contextmenu",i),removeScrollEventListener())}return document.addEventListener("click",i),document.addEventListener("contextmenu",i),o}async function updateChromeStoreInfo(){const e=await chrome.storage.local.get("expressFTEShown");let t=0;t=void 0===e?.expressFTEShown?1:(e.expressFTEShown?.shownCount||0)+1;const o={lastShownAt:(new Date).toISOString(),shownCount:t};chrome.storage.local.set({expressFTEShown:o})}const isExpressFteTooltipSecond=async()=>{const{env:e}=await chrome.storage.local.get("env");if("prod"===e)return!1;return!!new URLSearchParams(window.location.search).has("expressFteTooltipSecond")};async function shouldShowExpressFTE(e){if(!e.showExpressTooltip)return!1;const t=await chrome.storage.local.get("expressFTEShown");if(void 0===t?.expressFTEShown)return!0;if(3===t.expressFTEShown.shownCount)return!1;let o=new Date(t.expressFTEShown.lastShownAt);await isExpressFteTooltipSecond()?o.setSeconds(o.getSeconds()+7):o.setDate(o.getDate()+7);return new Date>=o}const addFontToDocument=async()=>{if(state.adobeCleanFontAdded)return;const e=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),t=new FontFace("AdobeClean-Regular",`url(${e})`);document.fonts.add(t),await t.load(),state.adobeCleanFontAdded=!0};function isInteractiveImage(e){const t=e.getBoundingClientRect(),o=document.elementsFromPoint(t.x+t.width/2,t.y+t.height/2);for(let t of o){if("A"===t.tagName||"INPUT"===t.tagName){if(t.contains(e))continue;return!1}return!!e.isSameNode(t)}return!1}function tryAttachTooltip(e,t){if(e.offsetHeight>=t.imageDimension.height&&e.offsetWidth>=t.imageDimension.width){const o=e.getBoundingClientRect();if(o.top+scrollY<130)return!1;if(o.left+o.width/2+scrollX<140||o.right-o.width/2+scrollX>window.innerWidth-140)return!1;if(!isInteractiveImage(e))return!1;const n=createExpressFTE({title:t.expressTooltipStrings.title,description:t.expressTooltipStrings.description,footer:t.expressTooltipStrings.footer},o);n.style.top=o.top+scrollY+"px",n.style.bottom=o.bottom+scrollY+"px";const i=o.left+(o.right-o.left)/2;return n.style.left=i-140+scrollX+"px",n.style.right=i+140+scrollX+"px",document.body.appendChild(n),!0}return!1}function scrollEventListener(e){var t=e.target;animationFrameTicking||(window.requestAnimationFrame((()=>{for(;t&&t!==document&&!isScrollable(t);)t=t.parent;if(t!==document&&t.contains(state.tooltipAttachedImage)){const e=document.getElementById("express-tooltip-ae68bdebea"),t=state.tooltipAttachedImage.getBoundingClientRect();e.style.top=t.top+"px"}animationFrameTicking=!1})),animationFrameTicking=!0)}function removeScrollEventListener(){window.removeEventListener("scroll",scrollEventListener,!0)}function isScrollable(e){return e.scrollWidth>e.clientWidth||e.scrollHeight>e.clientHeight}function inExceptionList(e,t){for(let o of e){const e=new RegExp(o.replaceAll(".",".").replaceAll("*",".*")+"$");if(t.match(e))return!0}return!1}function deleteTooltip(){const e=document.getElementById("express-tooltip-ae68bdebea");e?.remove()}function executeTooltipNudge(){window.addEventListener("load",(()=>{let e=0,t=setInterval((async()=>{const o=await chrome.runtime.sendMessage({main_op:"express-init"});if(o?.exceptionInfo.enabled){let e=exceptionList;if(o?.exceptionInfo.list&&(e=e.concat(o?.exceptionInfo.list)),inExceptionList(e,window.location.hostname))return void clearInterval(t)}if(!await shouldShowExpressFTE(o))return void clearInterval(t);await addFontToDocument();let n=!1;const i=document.getElementsByTagName("img");for(let e of i)if(tryAttachTooltip(e,o)){n=!0,state.tooltipAttachedImage=e,window.addEventListener("scroll",scrollEventListener,!0);break}e+=1,(n||e>=4)&&clearInterval(t)}),500)})),window.addEventListener("popstate",(()=>{deleteTooltip()})),window.addEventListener("beforeunload",(()=>{deleteTooltip()}))}executeTooltipNudge();