/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(()=>{const e="-shared",t="acrobatDisconnectContentScriptStart",o="acrobatContentScriptDisconnectEnd",n="acrobat-prompt",i="acrobat-fte-tooltip-container",r="acrobat-gdrive-fte-state";let c,a,s,d,l,m=!1,u=new AbortController,p={addedAdobeCleanFont:!1,fteToolTip:{}};const w=()=>!chrome.runtime?.id,h=()=>window.location.pathname.includes("/file"),g=e=>{l?.sendAnalytics(e)},b=t=>{if(m||t){const t=document.getElementsByClassName(n);if(t?.length>0){const e=t[0].getElementsByClassName(i);e?.length>0&&g(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),t[0].remove()}const o=document.getElementsByClassName(n+e);o?.length>0&&o[0].remove();const r=document.getElementById("acrobat-prompt");r?.remove(),m=!1}},v=(e,t)=>{if(e){const o=c?.selectors,n=o&&o[t];for(let t=0;t<n?.length;t++){let o=e.querySelector(n[t]);if(o)return o}}return null},f=()=>v(document,"fileDetails"),E=e=>{try{return JSON.parse(e?.textContent?.replace(/\\/g,""))}catch(e){return null}};let C="0";const T=()=>{const t=document.createElement("div"),o=(()=>{const e=document.createElement("img");e.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"));const t=h()?"acrobat-icon-shared":"acrobat-icon";return e.setAttribute("class",t),e})(),i=(()=>{const e=document.createElement("span"),t=h()?"acrobat-prompt-text-shared":"acrobat-prompt-text";return e.setAttribute("class",t),e.textContent=c?.acrobatPromptText||"Edit with Acrobat",e})(),a=(()=>{const e=document.createElement("div"),t=h()?"acrobat-prompt-tooltip":"acrobat-prompt-tooltip-shared";return e.setAttribute("class",t),e.textContent=c?.acrobatPromptText||"Open in Acrobat",e})(),s=h()?n+e:n;return t.setAttribute("class",s),t.appendChild(o),t.appendChild(a),t.appendChild(i),t.addEventListener("click",(()=>(()=>{if(w())return void b();const{acrobatTouchPointClicked:e,getAcrobatTouchPointFteEligibility:t}=d;e(r),p.fteToolTip.touchPointClicked=!0;const o=f(),n=E(o);g([["DCBrowserExt:Gdrive:OpenInExtension:Clicked",{gsuiteFte:t(c?.enableFteToolTip)}]]);const i=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(`https://drive.usercontent.google.com/download?id=${n.id}&authuser=${C}&acrobatPromotionSource=GoogleDriveNativeView`)+"&pdffilename="+encodeURIComponent(n.title);window.open(i,"_blank")})()),{signal:u.signal}),t},y=e=>{const t=document.getElementsByClassName(i);"Enter"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key&&"click"!==e.type||t?.length>0&&(t[0]?.contains(e.target)||(t[0].remove(),g(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),document.removeEventListener("click",y),document.removeEventListener("keydown",y)))},L=e=>{const{createFteTooltip:t}=d,o=t(c?.fteToolTipStrings,"gdriveNativeView");(e=>{e.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",(()=>{e.remove(),g(["DCBrowserExt:GdriveFTE:NativeView:Clicked"]),document.removeEventListener("click",y),document.removeEventListener("keydown",y)}))})(o),document.addEventListener("click",y,{signal:u.signal}),document.addEventListener("keydown",y,{signal:u.signal}),e.appendChild(o),g(["DCBrowserExt:GdriveFTE:NativeView:Shown"]);const{updateFteToolTipCoolDown:n}=d;n(c?.fteConfig?.tooltip,r).then((e=>{p.fteToolTip={...p?.fteToolTip,...e}}))},x=()=>{try{if(m)return;const e=T(),t=(()=>{let e;for(let t=0;t<c?.selectors?.promptParentElement.length&&(e=document.querySelector(c?.selectors?.promptParentElement[t]),!e);t++);return e})();if(t){if(t.prepend(e),m=!0,window.innerWidth>1080){g([["DCBrowserExt:Gdrive:OpenInExtension:Shown",{gsuiteFte:d?.getAcrobatTouchPointFteEligibility(c?.enableFteToolTip)}]]);const{shouldShowFteTooltip:t}=d,o=c?.fteConfig?.tooltip;t(o,p?.fteToolTip,c?.enableFteToolTip).then((t=>{t&&setTimeout((()=>{L(e)}),1e3)}))}}else b()}catch(e){b()}},D=()=>{const e=f();if(e){"application/pdf"===E(e).mimeType?x():b()}else b()},F=()=>{b(!0)},A=()=>{w()&&(s&&s.disconnect(),b(),u.abort(),window.dispatchEvent(new CustomEvent(o,{detail:{state:p}})))},R=()=>{window.addEventListener(o,(e=>(e=>{w()||(p=e.detail.state)})(e)),{signal:p?.eventControllerSignal}),window.dispatchEvent(new Event("orphanContentScript")),window.dispatchEvent(new Event(t)),window.addEventListener(t,A,{signal:u.signal}),chrome.runtime.sendMessage({main_op:"gdrive-init"},(e=>{(e.enableOpenInExtension||window.location?.search?.includes("enableAcrobatPromptInGSuite"))&&(()=>{const e=chrome.runtime.getURL("content_scripts/gsuite/fte-utils.js"),t=chrome.runtime.getURL("content_scripts/gsuite/util.js");return Promise.all([import(e),import(t)]).then((e=>{d=e[0],l=e[1]}))})().then((()=>{l?.sendAnalyticsOncePerMonth("DCBrowserExt:Gdrive:OpenInExtension:Enable"),e?.enableFteToolTip&&l?.sendAnalyticsOncePerMonth("DCBrowserExt:GdriveFTE:Enable"),c=e,(()=>{if(window?.document?.location?.pathname.includes("/u/"))return void(C=window.document.location.pathname.split("/")[3]);const e=document.createElement("script");document.addEventListener("acrobat-auth-user-id",(t=>{C=t?.detail?.authuser,e.remove()})),e.type="text/javascript",e.src=chrome.runtime.getURL("content_scripts/gdrive/get-auth-user.js"),document.head.appendChild(e)})(),a=chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"),(async()=>{const e=(new Date).getTime();let t={count:0,nextDate:e};t=(await chrome.storage.local.get(r))?.[r]||t;const o=c?.fteConfig?.tooltip;((e,t)=>-1!==e?.resetDay&&t>e?.resetDay)(o,e)&&(t.count=0,t.nextDate=e),p.fteToolTip={...t},t={[r]:t},chrome.storage.local.set(t)})(),(()=>{if(!p?.adobeCleanFontAdded){const e=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),t=new FontFace("AdobeClean-Regular",`url(${e})`);t.load().then((()=>{document.fonts.add(t)})),p.adobeCleanFontAdded=!0}})(),F(),D(),(()=>{try{const e={childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]};s=new MutationObserver((function(){s.takeRecords(),w()?(s.disconnect(),b()):D()})),s.observe(document.body,e)}catch(e){}})()}))}))},P=()=>{const e=new URLSearchParams(window.location.search);e?.has("acrobatPromotionSource")&&(e?.has("uuid")&&"https://accounts.google.com/"!==document.referrer||chrome.runtime.sendMessage({main_op:"gdrive-download-init"},(e=>{c=e;let{nameElement:t,pdfURLObject:o}=(()=>{const e=v(document,"confirmInput")?.value,t=v(document,"atInput")?.value,o=v(document,"uuidInput")?.value,n=v(document,"fileName");let i=new URL(window.location.href);return i.searchParams.set("uuid",o),i.searchParams.set("at",t),i.searchParams.set("confirm",e),{nameElement:n,pdfURLObject:i}})(),n=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(o.toString());t?.textContent&&(n=n+"&pdffilename="+encodeURIComponent(t?.textContent)),g([["DCBrowserExt:GdriveDPage:Redirect"]]),window.location.replace(n)})))};chrome.runtime.onMessage.addListener((function(e){"acrobatGsuiteTouchPointsDisabled"===e.content_op&&(s?.disconnect(),F())})),chrome.runtime.onMessage.addListener((function(e){"acrobatGdriveFteStateUpdated"===e.content_op&&(p.fteToolTip={...p?.fteToolTip,...e?.fteState})})),chrome.storage.local.get("acrobat-gsuite-touch-points",(e=>{"false"!==e["acrobat-gsuite-touch-points"]&&("drive.google.com"===window?.document?.location?.host&&window.top===window.self&&0===window?.document?.location?.ancestorOrigins.length?R():"drive.usercontent.google.com"===window?.document?.location?.host&&window.top===window.self&&0===window?.document?.location?.ancestorOrigins.length&&P())}))})();