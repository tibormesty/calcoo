/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{events as e}from"../../common/analytics.js";import{dcLocalStorage as t}from"../../common/local-storage.js";import{util as n}from"./content-util.js";import{updateExtUserState as i}from"../../common/util.js";await t.init();const o=t.getItem("appLocale");var a,s,r=!1,l=!1,c=1500,d=3e3,_=1500;function f(e,t,i){delete e.click_context,e.authenticatedPDF&&1==e.authenticatedPDF&&delete e.authenticatedPDF,n.messageToMain(e,i),delete e.newUI,delete e.analytics,delete e.is_viewer,delete e.reload_in_native,s&&(clearTimeout(s),s=null),t||"dismiss"===e.content_op||"resize_window"===e.content_op||E()}function m(){s&&(clearTimeout(s),s=null),SETTINGS.IS_ERP_READER?$(".acrobatMainDiv").stop().css("display","none"):$(".acrobatMainDiv").stop().css("opacity",1)}function p(){delete a.current_status,delete a.file_path,delete a.domtitle,delete a.timing,delete a.panel_op,delete a.is_pdf,delete a.newUI}function u(e,t){const i={main_op:"analytics",analytics:[[e,t]]};n.messageToMain(i)}function E(){p(),a.forced_cancel=!0,a.content_op="dismiss",a.main_op="relay_to_content","search"===a.frictionless_workflow&&1==a.show_frictionless&&(a.suppress_frictionless=!0),delete a.newUI,f(a)}function I(){s=null,$(".acrobatMainDiv").animate({opacity:0},_,"swing",E)}function g(){s||r||(s=setTimeout((function(){setTimeout(I)}),a.is_pdf?d:c))}function w(e){try{let t=new URL(a.frictionless_uri);e.origin===t.origin&&(a.main_op="external_msg",a.data=e.data,a.timeStamp=Date.now(),n.messageToMain(a))}catch(e){}}function S(){u(e.TREFOIL_SETTINGS_ICON_CLICKED),chrome.runtime.openOptionsPage((t=>{chrome.runtime.lastError&&u(e.TREFOIL_SETTINGS_FAILED_TO_OPEN)}))}function h(){l||(l=!0,window.addEventListener("message",w,!1),$(".close-dialog").click((function(){$(".acrobatMainDiv").length>0&&$(".acrobatMainDiv").hasClass("widget-screen-main-div")&&n.analytics(a,e.FRICTIONLESS_WIDGET_CROSS_CLICKED),E()})),$(".settings-dialog").click(S),$(".action-available-click").click((function(t){let i=$(t.currentTarget);m(),n.consoleLog(i),a.main_op="go_to_aonline",a.verb="acrobat_label",u(e.TREFOIL_ACROBAT_LABEL_CLICKED),f(a)})),$(".acrobatMainDiv").hover(m,g),$(".sign-out").click((function(){m(),n.analytics(a,e.SIGN_OUT_CLICKED),a.main_op="sign-out",f(a)})),$(".do-acro-prefs").click((function(){n.analytics(a,e.TREFOIL_HTML_PREFERENCES_CLICK),a.main_op="showConversionSettingsDialog",f(a)})))}function T(s){let l;if(a&&s&&a.tabId&&s.tabId&&s.tabId!=a.tabId)return;if(!s.main_op||!["analytics","save-preferences","fetch-preferences","userSubscriptionData"].includes(s.main_op)){switch(s.version===SETTINGS.ERP_READER_VER&&(SETTINGS.IS_ERP_READER=!0),h(),delete(a={...s,tabId:a.tabId}).analytics,m(),r=!1,n.translateElements(".translate"),$("#action_message").text(""),function(e,t){if(SETTINGS.DEBUG_MODE){let i,o=[t];for(i in e)e.hasOwnProperty(i)&&o.push("  "+i+": "+e[i]);n.consoleLog(o.join("\n"))}}(a,"Receive frame message:"),l=a.panel_op,delete a.panel_op,l){case"load-frictionless":if(r=!0,"resize_window"===a.content_op);else if(1==a.hide_spinner)delete a.hide_spinner,$(".frictionless-container").removeClass("hidden"),$(".frictionless-loader").addClass("hidden");else if(0==$(".frictionless-container").children().length){$(".acrobatMainDiv").removeClass("home-screen"),$(".acrobatMainDiv").addClass("widget-screen-main-div"),$(".actions").addClass("hidden"),"search"===a.frictionless_workflow&&i();let n=function(n,i){let s=document.createElement("iframe");s.setAttribute("referrerpolicy","no-referrer"),s.classList.add("frictionless-iframe");let r=new URL(n);if(i&&(o?i.locale=o:a.locale?i.locale=a.locale:i.locale=chrome.i18n.getMessage("@@ui_locale"),Object.keys(i).forEach((e=>{r.searchParams.append(e,i[e])}))),"false"===t.getItem("logAnalytics")){let e=r.toString();e=e.concat("&app!analytics=disable");try{r=new URL(e)}catch(e){r=""}}if("test"===a.env||"stage"===a.env){let e=r.toString();e=e.concat("&app!versions=latest");try{r=new URL(e)}catch(e){r=""}}return s.onerror=function(){u(e.FRICTIONLESS_WIDGET_LOADING_FAILED)},s.onload=function(){f({iframe_onload_time:Date.now(),main_op:"timing_info",timing_op:"startup_to_iframe_load"},!0),"trefoil"===i.workflow&&s.contentWindow.postMessage({valid:!0},r.origin)},f({iframe_call_time:Date.now(),main_op:"timing_info"},!0),s.setAttribute("src",r),s}(a.frictionless_uri,{verb:a.pdf_action,workflow:a.frictionless_workflow,dropzone2:"true",useExtensionStorage:!0});$(".frictionless-container").append(n),$(".frictionless-host").removeClass("hidden"),v()}break;case"show-frictionless-error":if(a.error_title&&a.error_description){let e=a.error_title,t=a.error_description;delete a.error_title,delete a.error_description,function(e,t){const n=$(".frictionless-error"),i=$(".error-title");$(".error-details").text(t),i.text(e),n.removeClass("hidden"),v()}(e,t)}break;case"clear-frictionless-error":$(".frictionless-error").addClass("hidden"),v();break;case"send-external-msg":try{let e=new URL(a.frictionless_uri),t=$(".frictionless-iframe");if(1==t.length){t[0].contentWindow.postMessage(a.data,e.origin),delete a.data}}catch(e){}r=!0}g()}}function v(){p(),a.content_op="resize_window",a.panel_op="load-frictionless",a.main_op="relay_to_content",delete a.newUI,f(a),a.content_op=null,a.panel_op=null}n.addMainListener(T),$((function(){h(),window.location.search&&(a=JSON.parse(decodeURIComponent(window.location.search.split("=")[1])),SETTINGS.TEST_MODE&&window.addEventListener("message",(function(e){T(e.data)}),!1),$("body").addClass("desktop-app-reader"),"html_menu"==a.panel_op&&($(".acrobatMainDiv").addClass("home-screen"),u(e.FRICTIONLESS_HOME_SCREEN_SHOWN)),function(e){var t;void 0!==(t=e)&&void 0!==t.paramName&&delete t.paramName,SETTINGS.FILL_N_SIGN_ENABLED=e.isFillnSignEnabled,SETTINGS.SHAREPOINT_ENABLED=e.isSharePointEnabled,T(e)}(a))}));