/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../../common/analytics.js";import{dcLocalStorage as o}from"../../common/local-storage.js";import{loggingApi as n}from"../../common/loggingApi.js";import{common as r}from"../../sw_modules/common.js";import{EXPRESS as s}from"../../sw_modules/constant.js";import{util as a}from"../../sw_modules/util.js";(async()=>{const i="expressPluginIframe";let E,c,l;function m(){const e=document.getElementById("loaderId");e&&e.parentNode&&e.parentNode.removeChild(e)}const d=async e=>{const t=await fetch(e),o=await t.blob();return new Promise(((e,t)=>{const n=new FileReader;n.readAsDataURL(o),n.onloadend=()=>{const t=n.result;e(t)},n.onerror=t}))};function p(){var e=$("#expressAcrobatExtensionIframe");0===e.length?(e=$("<iframe>")).attr("id","expressAcrobatExtensionIframe").css({border:"0px","z-index":2147483647,position:"fixed",width:"500px",height:"50px",display:"block",margin:"auto",background:"transparent","color-scheme":"auto",bottom:"50px",right:"calc(50% - 250px)","border-radius":"4px"}).attr("src",chrome.runtime.getURL("browser/js/failToast.html")).appendTo("html"):"none"===e.css("display")&&e.css({display:"block"})}await o.init(),function(){const e=o.getItem("env");r.reset(e),E=r.settings.expressPluginUrl,c=new URL(E)}(),window.addEventListener("message",(E=>{if(E.origin===c.origin)switch(E.data?.type){case"EMBED_SDK_ON_LOAD":e.event(t.EXPRESS_EXECUTE_VERB_EDITOR_LOADED,{VERB:l}),m(),document.querySelector(`#${i}`).focus();break;case"EMBED_SDK_READY":!function(){const E=o.getItem(s.CONTEXT_MENU_ON_CLICK_INFO_LOCAL_STORAGE_KEY);o.removeItem(s.CONTEXT_MENU_ON_CLICK_INFO_LOCAL_STORAGE_KEY),l=E.menuItemId.replace("ContextMenu",""),d(E.srcUrl).then((e=>{const t={asset:{data:e,dataType:"base64",type:"image"}};switch(l){case s.VERBS.EFFECTS_IMAGE:t.intent="add-effects";break;case s.VERBS.ADJUSTMENTS_IMAGE:t.intent="apply-adjustment";break;case s.VERBS.GENERATIVE_FILL:t.intent="gen-fill";break;case s.VERBS.CROP_IMAGE:t.intent="crop-image";break;case s.VERBS.REMOVE_BACKGROUND_IMAGE:t.intent="remove-background"}let n=function(e){const t=[{id:"save",label:a.getTranslation("expressExportOptionsSaveLabel"),action:{target:"publish",closeTargetOnExport:!1},style:{uiType:"button"}}];return{type:"LAUNCH_MODULE",data:{hostInfo:{clientId:r.getViewerIMSClientId(),appName:"Adobe Acrobat Extension"},intent:"edit-image",component:"MODULE",configParams:{locale:o.getItem("appLocale")||a.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")),env:r.getEnv()},appConfig:{allowedFileTypes:["image/png"]},docConfig:e,exportConfig:t}}}(t);document.getElementById(i).contentWindow.postMessage(n,c.origin)})).catch((o=>{m(),p(),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:l}),n.error({message:"Error received in express flow",error:o.toString()})}))}();break;case"EMBED_SDK_PUBLISH":e.event(t.EXPRESS_EXECUTE_VERB_EDITOR_PUBLISHED,{VERB:l});break;case"EMBED_SDK_CANCEL":e.event(t.EXPRESS_EXECUTE_VERB_EDITOR_CLOSED,{VERB:l}),chrome.runtime.sendMessage({main_op:"closeExpressApp"});break;case"EMBED_SDK_ERROR":m(),p(),e.event(t.EXPRESS_EXECUTE_VERB_ERROR_OCCURRED,{VERB:l}),n.error({message:"Error received in express flow",error:E.data?.message})}})),function(){const e=document.createElement("iframe");e.setAttribute("src",E),e.setAttribute("id",i),e.setAttribute("allowfullscreen","true"),e.setAttribute("allow","clipboard-read; clipboard-write;"),e.setAttribute("style","position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;"),document.body.appendChild(e)}()})();