/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{fileUtil as e}from"../viewer/fileUtil.js";import{getActiveTasks as t,setCloseRequested as n,wrapTask as i}from"./offscreenTaskManager.js";import{offscreenConfig as r}from"./offscrenUtil.js";let a;const o=new URLSearchParams(window.location.search),s=o.get("env")||"prod",d=o.get("rrv")||"false",c="iframe#user-subscription-iframe";function f(e){const t=window.document.getElementById("ajs-worker-iframe"),n=r[s].acrobat_viewer_origin;t&&t.contentWindow.postMessage(e,n)}function u(e){if(!window.document.querySelector(c)&&e.cdnURL){const t=window.document;if(e.isCDNSignInEnabled){const t=new URL(e.signInURL);a=`${t}?main_op=fus`}else a=`${e.cdnURL}#/susi/fetchUserSubscription`;const n=t.createElement("iframe");n.setAttribute("src",a),n.setAttribute("id","user-subscription-iframe");t.getElementById("cdn-dnr-iframe").appendChild(n)}}function m(){0==t()?chrome.runtime.sendMessage({main_op:"closeOffscreenDocument",target:"background",tab:{id:""}}):setTimeout(m,100)}chrome.runtime.onMessage.addListener((async function(e){if("offscreen"!==e.target)return!1;const t={getUserSubscriptions:i("getUserSubscriptions",u),getFileBuffer:i("getFileBuffer",(async e=>{const t=await fetch(e.fileBufferBlob),n=await t.blob(),i=await new Response(n).arrayBuffer();f({main_op:"getFileBuffer",tabId:e.tabId,fileInfo:{fileBuffer:i,docLastOpenState:e.docLastOpenState}})})),closeIframeOfUserSubscription:i("closeIframeOfUserSubscription",(()=>{var e;e=c,window.document.querySelector(e).remove()})),getLinearizedRendition:i("getLinearizedRendition",(e=>{f({main_op:"getLinearizedRendition",tabId:e.tabId,pdfURL:e.pdfURL,pdfSize:e.pdfSize,docLastOpenState:e.docLastOpenState})})),getFileSize:i("getFileSize",f),rrvLayerRemoved:i("rrvLayerRemoved",(e=>{f({main_op:"rrvLayerRemoved",tabId:e.tabId})}))};if(!t[e.main_op])return console.warn(`Unexpected message type received: '${e.main_op}'.`),!1;await t[e.main_op](e)})),window.addEventListener("message",(function(t){if(t.origin!==new URL(a).origin)return;const r=t.data;"lastUserGuid"===r.type&&(r.main_op="updateSignInStatus",delete r.type);const o={userSubscriptions:i("userSubscriptions",(()=>{chrome.runtime.sendMessage({...r,target:"background",tab:{id:""}})})),updateSignInStatus:i("updateSignInStatus",(()=>{chrome.runtime.sendMessage({...r,target:"background",tab:{id:""}})})),closeOffscreenDocument:()=>{n(!0),m()},getFileBufferRange:i("getFileBufferRange",(async()=>{try{const t=await e.getFileBufferRange({url:r.pdfURL},r.range),n=await new Response(t.buffer).arrayBuffer();f({main_op:"acceptRangesBuffer",tabId:r.tabId,fileBuffer:n,rangeKey:`${r.range.start}-${r.range.end}`,fileSize:t.fileSize})}catch{f({main_op:"acceptRangesBuffer",tabId:r.tabId,fileBuffer:-1,rangeKey:`${r.range.start}-${r.range.end}`,fileSize:-1})}})),rapidRenditionResponse:i("rapidRenditionResponse",(()=>{chrome.runtime.sendMessage({...r,target:"background",tab:{id:r.tabId}})})),rapidRenditionError:i("rapidRenditionError",(()=>{chrome.runtime.sendMessage({...r,target:"background",tab:{id:r.tabId}})}))};o[r?.main_op]&&o[r.main_op]()})),window.onload=()=>{"true"===d&&function(){const e=window.document;a=r[s].ajs_worker_uri+"?callingApp="+window.location.host;const t=e.createElement("iframe");t.setAttribute("src",a),t.setAttribute("id","ajs-worker-iframe"),e.getElementById("cdn-dnr-iframe").appendChild(t)}()};